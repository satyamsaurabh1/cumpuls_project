{"ast":null,"code":"import React,{createContext,useState,useContext,useEffect}from'react';import io from'socket.io-client';import{useAuth}from'./AuthContext';import toast from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const SocketContext=/*#__PURE__*/createContext();export const useSocket=()=>{const context=useContext(SocketContext);if(!context){throw new Error('useSocket must be used within a SocketProvider');}return context;};export const SocketProvider=_ref=>{let{children}=_ref;const[socket,setSocket]=useState(null);const[onlineUsers,setOnlineUsers]=useState([]);const{user,isAuthenticated}=useAuth();const seenMessageIdsRef=React.useRef(new Set());useEffect(()=>{if(isAuthenticated&&user){const SOCKET_URL=process.env.REACT_APP_SOCKET_URL||'http://localhost:5001';const newSocket=io(SOCKET_URL,{auth:{token:localStorage.getItem('token')}});newSocket.on('connect',()=>{console.log('Socket connected');});newSocket.on('user:online',users=>{setOnlineUsers(users);});newSocket.on('user:offline',userId=>{setOnlineUsers(prev=>prev.filter(id=>id!==userId));});newSocket.on('message:received',message=>{var _message$sender,_message$sender$_id,_message$sender$_id$t,_message$receiver,_message$receiver$_id,_message$receiver$_id2,_user$_id,_user$_id$toString;const messageId=message===null||message===void 0?void 0:message._id;const senderId=(message===null||message===void 0?void 0:(_message$sender=message.sender)===null||_message$sender===void 0?void 0:(_message$sender$_id=_message$sender._id)===null||_message$sender$_id===void 0?void 0:(_message$sender$_id$t=_message$sender$_id.toString)===null||_message$sender$_id$t===void 0?void 0:_message$sender$_id$t.call(_message$sender$_id))||'';const receiverId=(message===null||message===void 0?void 0:(_message$receiver=message.receiver)===null||_message$receiver===void 0?void 0:(_message$receiver$_id=_message$receiver._id)===null||_message$receiver$_id===void 0?void 0:(_message$receiver$_id2=_message$receiver$_id.toString)===null||_message$receiver$_id2===void 0?void 0:_message$receiver$_id2.call(_message$receiver$_id))||'';const currentUserId=(user===null||user===void 0?void 0:(_user$_id=user._id)===null||_user$_id===void 0?void 0:(_user$_id$toString=_user$_id.toString)===null||_user$_id$toString===void 0?void 0:_user$_id$toString.call(_user$_id))||'';// Prevent duplicate notifications from multi-emits and only notify receiver.\nif(!messageId||seenMessageIdsRef.current.has(messageId))return;seenMessageIdsRef.current.add(messageId);if(seenMessageIdsRef.current.size>300){// Keep memory bounded in long sessions.\nseenMessageIdsRef.current.clear();seenMessageIdsRef.current.add(messageId);}const isIncomingForCurrentUser=receiverId===currentUserId&&senderId&&senderId!==currentUserId;if(!isIncomingForCurrentUser)return;toast.success(/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{children:\"New message from \".concat(message.sender.name)}),/*#__PURE__*/_jsx(\"div\",{children:message.content})]}),{duration:4000});});newSocket.on('error',error=>{toast.error(error.message);});setSocket(newSocket);return()=>{newSocket.close();};}},[isAuthenticated,user]);const joinConversation=userId=>{if(socket){socket.emit('conversation:join',{userId});}};const sendMessage=(receiverId,content)=>{if(socket){socket.emit('message:send',{receiverId,content});}};const startTyping=receiverId=>{if(socket){socket.emit('typing:start',{receiverId});}};const stopTyping=receiverId=>{if(socket){socket.emit('typing:stop',{receiverId});}};const value={socket,onlineUsers,joinConversation,sendMessage,startTyping,stopTyping,isOnline:userId=>onlineUsers.includes(userId)};return/*#__PURE__*/_jsx(SocketContext.Provider,{value:value,children:children});};","map":{"version":3,"names":["React","createContext","useState","useContext","useEffect","io","useAuth","toast","jsx","_jsx","jsxs","_jsxs","SocketContext","useSocket","context","Error","SocketProvider","_ref","children","socket","setSocket","onlineUsers","setOnlineUsers","user","isAuthenticated","seenMessageIdsRef","useRef","Set","SOCKET_URL","process","env","REACT_APP_SOCKET_URL","newSocket","auth","token","localStorage","getItem","on","console","log","users","userId","prev","filter","id","message","_message$sender","_message$sender$_id","_message$sender$_id$t","_message$receiver","_message$receiver$_id","_message$receiver$_id2","_user$_id","_user$_id$toString","messageId","_id","senderId","sender","toString","call","receiverId","receiver","currentUserId","current","has","add","size","clear","isIncomingForCurrentUser","success","concat","name","content","duration","error","close","joinConversation","emit","sendMessage","startTyping","stopTyping","value","isOnline","includes","Provider"],"sources":["C:/Users/satya/OneDrive/Desktop/creatorconnect-backend/frontend/src/context/SocketContext.js"],"sourcesContent":["import React, { createContext, useState, useContext, useEffect } from 'react';\nimport io from 'socket.io-client';\nimport { useAuth } from './AuthContext';\nimport toast from 'react-hot-toast';\n\r\nconst SocketContext = createContext();\r\n\r\nexport const useSocket = () => {\r\n  const context = useContext(SocketContext);\r\n  if (!context) {\r\n    throw new Error('useSocket must be used within a SocketProvider');\r\n  }\r\n  return context;\r\n};\r\n\r\nexport const SocketProvider = ({ children }) => {\n  const [socket, setSocket] = useState(null);\n  const [onlineUsers, setOnlineUsers] = useState([]);\n  const { user, isAuthenticated } = useAuth();\n  const seenMessageIdsRef = React.useRef(new Set());\n\r\n  useEffect(() => {\r\n    if (isAuthenticated && user) {\r\n      const SOCKET_URL = process.env.REACT_APP_SOCKET_URL || 'http://localhost:5001';\n      \r\n      const newSocket = io(SOCKET_URL, {\r\n        auth: {\r\n          token: localStorage.getItem('token')\r\n        }\r\n      });\r\n\r\n      newSocket.on('connect', () => {\r\n        console.log('Socket connected');\r\n      });\r\n\r\n      newSocket.on('user:online', (users) => {\r\n        setOnlineUsers(users);\r\n      });\r\n\r\n      newSocket.on('user:offline', (userId) => {\r\n        setOnlineUsers(prev => prev.filter(id => id !== userId));\r\n      });\r\n\r\n      newSocket.on('message:received', (message) => {\n        const messageId = message?._id;\n        const senderId = message?.sender?._id?.toString?.() || '';\n        const receiverId = message?.receiver?._id?.toString?.() || '';\n        const currentUserId = user?._id?.toString?.() || '';\n\n        // Prevent duplicate notifications from multi-emits and only notify receiver.\n        if (!messageId || seenMessageIdsRef.current.has(messageId)) return;\n        seenMessageIdsRef.current.add(messageId);\n        if (seenMessageIdsRef.current.size > 300) {\n          // Keep memory bounded in long sessions.\n          seenMessageIdsRef.current.clear();\n          seenMessageIdsRef.current.add(messageId);\n        }\n\n        const isIncomingForCurrentUser =\n          receiverId === currentUserId && senderId && senderId !== currentUserId;\n        if (!isIncomingForCurrentUser) return;\n\n        toast.success(\n          <div>\n            <div>{`New message from ${message.sender.name}`}</div>\n            <div>{message.content}</div>\n          </div>,\n          {\n          duration: 4000\n          }\n        );\n      });\n\r\n      newSocket.on('error', (error) => {\r\n        toast.error(error.message);\r\n      });\r\n\r\n      setSocket(newSocket);\r\n\r\n      return () => {\r\n        newSocket.close();\r\n      };\r\n    }\r\n  }, [isAuthenticated, user]);\r\n\r\n  const joinConversation = (userId) => {\r\n    if (socket) {\r\n      socket.emit('conversation:join', { userId });\r\n    }\r\n  };\r\n\r\n  const sendMessage = (receiverId, content) => {\r\n    if (socket) {\r\n      socket.emit('message:send', { receiverId, content });\r\n    }\r\n  };\r\n\r\n  const startTyping = (receiverId) => {\r\n    if (socket) {\r\n      socket.emit('typing:start', { receiverId });\r\n    }\r\n  };\r\n\r\n  const stopTyping = (receiverId) => {\r\n    if (socket) {\r\n      socket.emit('typing:stop', { receiverId });\r\n    }\r\n  };\r\n\r\n  const value = {\r\n    socket,\r\n    onlineUsers,\r\n    joinConversation,\r\n    sendMessage,\r\n    startTyping,\r\n    stopTyping,\r\n    isOnline: (userId) => onlineUsers.includes(userId)\r\n  };\r\n\r\n  return (\r\n    <SocketContext.Provider value={value}>\r\n      {children}\r\n    </SocketContext.Provider>\r\n  );\r\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}